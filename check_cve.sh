#! /bin/sh
# Script to generate cve against given target passed as command line

TARGET=$1
OUTPUT=`pwd`/../buildroot/output/$TARGET/images
SBOM_HOST=$TARGET-host-sbom.txt
SBOM_TARGET=$TARGET-target-sbom.txt
CVE_HOST=$TARGET-host-cve.xml
CVE_TARGET=$TARGET-target-cve.xml

#download nvd-cve files
update_dbs()
{
mkdir -p dbs
cd dbs
rm *.xml

year=`date +"%Y"`
for i in $(seq -f "%04g" 2002 $year)
do
    wget https://nvd.nist.gov/download/nvdcve-$i.xml.gz
    gunzip nvdcve-$i.xml.gz
done
cd ..
}

#check cve for host and target sbom
check_cve()
{
./cli.py -f rpm $OUTPUT/$SBOM_HOST dbs $TARGET -a 0 -i warning_list -x fixed_list> $OUTPUT/$CVE_HOST
./cli.py -f rpm $OUTPUT/$SBOM_TARGET dbs $TARGET -a 0 -i warning_list -x fixed_list > $OUTPUT/$CVE_TARGET
}

####main
echo "Downloading NVD-CVE files.."
update_dbs
echo "Performing CVE check.."
check_cve
echo "Done..."
